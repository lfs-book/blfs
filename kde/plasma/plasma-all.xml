<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
 <!ENTITY % general-entities SYSTEM "../../general.ent">
 %general-entities;

  <!ENTITY plasma-download-http "https://download.kde.org/stable/plasma/&plasma-version;">
  <!ENTITY plasma-download-ftp  " ">
  <!ENTITY plasma-md5sum        "See Below">
  <!ENTITY plasma-size          "220 MB">
  <!ENTITY plasma-buildsize     "1.1 GB (557 MB installed)">
  <!ENTITY plasma-time          "15 SBU (using parallelism=8)">
]>

<sect1 id="plasma-build" xreflabel="Plasma-&plasma-version;">
  <?dbhtml filename="plasma-all.html"?>


  <title>Building Plasma</title>

  <indexterm zone="plasma-build">
     <primary sortas="a-kde-plasma">KDE Plasma</primary>
  </indexterm>

  <para>
    KDE Plasma is a collection of packages based on top of KDE Frameworks
    and QML. They implement the KDE Display Environment (Plasma).
  </para>

  &lfs122_checked;

  <para>
    The instructions below build all of the Plasma packages in one
    step by using a bash script.
  </para>

  <bridgehead renderas="sect3">Package Information</bridgehead>
  <itemizedlist spacing="compact">
    <listitem>
      <para>
        Download (HTTP): <ulink url="&plasma-download-http;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Download (FTP): <ulink url="&plasma-download-ftp;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Download MD5 sum: &plasma-md5sum;
      </para>
    </listitem>
    <listitem>
      <para>
        Download size: &plasma-size;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimated disk space required: &plasma-buildsize;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimated build time: &plasma-time;
      </para>
    </listitem>
  </itemizedlist>

  <bridgehead renderas="sect3">Plasma Dependencies</bridgehead>

  <bridgehead renderas="sect4">Required</bridgehead>
  <para role="required">
    <xref linkend="boost"/>,
    <xref linkend="ffmpeg"/>,
    <xref linkend="gtk3"/>,
    <xref linkend="kf6-frameworks"/>,
    <xref linkend="kirigami-addons"/>,
    <xref linkend="libdisplay-info"/>,
    <xref linkend="libpwquality"/>,
    <xref linkend="libqalculate"/>,
    <xref linkend="libnl"/>,
    <xref linkend="libxcvt"/>,
    <xref linkend="libxkbcommon"/>,
    <xref linkend="mesa"/> built with <xref linkend="wayland"/>,
    <xref linkend="pipewire"/>,
    <xref linkend="pulseaudio-qt"/>,
    <xref linkend="qca"/>,
    <xref linkend="qcoro"/>,
    <xref linkend="sassc"/>,
    <xref linkend="taglib"/>, 
    <xref linkend="xdotool"/>, and 
    <xref linkend="xorg-evdev-driver"/>
  </para>

  <bridgehead renderas="sect4">Recommended</bridgehead>
  <para role="recommended">
    <xref linkend="gsettings-desktop-schemas"/>,
    <xref linkend="libcanberra"/>,
    <xref linkend="libinput"/>,
    <xref linkend="libpcap"/>,
    <xref linkend="libwacom"/>,
    <xref linkend="linux-pam"/>,
    <xref linkend="lm_sensors"/>,
    <xref linkend="oxygen-icons"/>, 
    <xref linkend="pciutils"/>, 
    <xref linkend="power-profiles-daemon"/>, and 
    the following Python modules: 
      <xref linkend="psutil"/>,
      <xref linkend="pygdbmi"/>,
      <xref linkend="sentry-sdk"/>, 
      <xref linkend="urllib3"/> (if they are not installed, they will be
      downloaded and installed by the drkonqi build procedure)
  </para>

  <bridgehead renderas="sect4">Recommended (runtime)</bridgehead>
  <para role="recommended">
    <xref role="runtime" linkend="accountsservice"/>,
    <xref role="runtime" linkend="breeze-icons"/>,
    <xref role="runtime" linkend="kio-extras"/>,
    <xref role="runtime" linkend="smartmontools"/>,
    <xref role="runtime" linkend="xdg-desktop-portal"/>, and
    <xref role="runtime" linkend="xwayland"/>
  </para>

  <bridgehead renderas="sect4">Optional</bridgehead>
  <para role="optional">
    <xref linkend="appstream"/> (build with -qt=true),
    <xref linkend="glu"/>,
    <xref linkend='ibus'/>,
    <xref linkend='qtwebengine'/>,
    <xref linkend="xorg-synaptics-driver"/>,
    <ulink url="https://www.kdevelop.org/">KDevPlatform</ulink>,
    <ulink url="https://gpsd.gitlab.io/gpsd/">libgps</ulink>,
    <ulink url="https://github.com/libhybris/libhybris">libhybris</ulink>,
    <ulink url="https://www.freedesktop.org/software/PackageKit/releases/">packagekit-qt</ulink>,
    <ulink url="https://launchpad.net/qapt">Qapt</ulink>,
    <ulink url="https://github.com/osiam/osiam">SCIM</ulink>, and
    <ulink url="http://www.dest-unreach.org/socat/">socat</ulink> (for pam_kwallet)
  </para>

  <sect2>
    <title>Downloading KDE Plasma</title>

    <para>
      The easiest way to get the KDE Plasma packages is to use a single
      <command>wget</command> to fetch them all at once:
    </para>

<screen><userinput>url=https://download.kde.org/stable/plasma/&plasma-version;/
wget -r -nH -nd -A '*.xz' -np $url</userinput>
<literal>
The options used here are:
  -r            recurse through child directories
  -nH           disable generation of host-prefixed directories
  -nd           do not create a hierarchy of directories
  -A '*.xz'     just get the *.xz files
  -np           don't get parent directories</literal></screen>

   </sect2>

  <sect2>
    <title>Setting Package Order</title>

    <para>
      The order of building files is important due to internal dependencies.
      Create the list of files in the proper order as follows:
    </para>

<screen><userinput>cat &gt; plasma-&plasma-version;.md5 &lt;&lt; "EOF"
<literal>d45182d9750cdd4a44dea312340aa44d  kdecoration-6.2.4.tar.xz
d6138bd3fee9280035140b13dd412b34  libkscreen-6.2.4.tar.xz
74e01a9cca86c37c3123f6ff5dfcda90  libksysguard-6.2.4.tar.xz
abf45c8785d3b0d424c3adbaaaa232d3  breeze-6.2.4.tar.xz
9ebbb0dcb0429259b70e277fbb2ad863  breeze-gtk-6.2.4.tar.xz
616e6ff8ac36fcb83034b4323c0a0042  layer-shell-qt-6.2.4.tar.xz
e5f30475eedf219b7b2018ea47f82789  plasma-activities-6.2.4.tar.xz
572785ac1859e74e3ce73f7ce72c117b  libplasma-6.2.4.tar.xz
42e05149b6ff48c972fa25212fddc146  kscreenlocker-6.2.4.tar.xz
4c2a4cf2f9331d6e077dbd049af1bf20  kinfocenter-6.2.4.tar.xz
5e57d4f3cc9f6c53de892c9ced82517e  kglobalacceld-6.2.4.tar.xz
76e7a22a26b48b85aed88b9df0d9f9ad  kwayland-6.2.4.tar.xz
1114b7215ba1196c5f5c3f2ae5bbef52  kwin-6.2.4.tar.xz
885b799c6b42e33d0784f5f0d3932bdb  plasma5support-6.2.4.tar.xz
adf34da687444af8e1b2816887fd0249  plasma-activities-stats-6.2.4.tar.xz
e61e926038b6cb2c2b8bb97a7693022a  kpipewire-6.2.4.tar.xz
10b196bd84ff8e3d71811e96d1040b91  plasma-workspace-6.2.4.tar.xz
f30e9c5962ea5c7df0a8e239bdad97d8  plasma-disks-6.2.4.tar.xz
20805abd1814da27991cd31e1a5e4d40  bluedevil-6.2.4.tar.xz
5d4f1b5b90fc531ef3015a9b85b867ca  kde-gtk-config-6.2.4.tar.xz
2737e30338a08ebec8b3a77eacd08dcf  kmenuedit-6.2.4.tar.xz
3a2f8554367848ba8d92e4d22a7038b3  kscreen-6.2.4.tar.xz
9cba151ec1093380e18d344cb59621f8  kwallet-pam-6.2.4.tar.xz
d81760474bc88de769affb0dcf5396d5  kwrited-6.2.4.tar.xz
ad82b1814d1342015d3fe5c7fa6d9038  milou-6.2.4.tar.xz
9f982db1280c9f6cd2f04db3ff37e67c  plasma-nm-6.2.4.tar.xz
73037a46ad7c06f1f98365f49fc3844d  plasma-pa-6.2.4.tar.xz
7c6f211d396b1442dc1d04569c915c1c  plasma-workspace-wallpapers-6.2.4.tar.xz
30dc7fce2c3eca48f36180f67dcb016b  polkit-kde-agent-1-6.2.4.tar.xz
7f6ee12b0e24ac327a77e4f4a1cdddc4  powerdevil-6.2.4.tar.xz
8cad5a2963eb7875961bb6ca6bdaf492  plasma-desktop-6.2.4.tar.xz
ea36155e721421ea2713d656079626dd  kgamma-6.2.4.tar.xz
a26edf04d2305053e3ef8ce418cb845f  ksshaskpass-6.2.4.tar.xz
#0b6652f78f37aeb130e068a690c27b12  plasma-sdk-6.2.4.tar.xz
31d57c1044de454b81b292bae3e245d8  sddm-kcm-6.2.4.tar.xz
#7d9728fa0e849504a394454657846067  discover-6.2.4.tar.xz
#b73b03b1a76cfa4b2158be6c3ce57c8b  breeze-grub-6.2.4.tar.xz
#09b9de495bb0d059903fe48c81492c40  breeze-plymouth-6.2.4.tar.xz
1b9cbac512b186ac913683c10fe62a77  kactivitymanagerd-6.2.4.tar.xz
12665b88d77efbfc55e38c62c1cd3710  plasma-integration-6.2.4.tar.xz
#234a0b42df3f62e139fd75bf0e685a5b  plymouth-kcm-6.2.4.tar.xz
dbb281caa803293cb24f2e52771d993a  xdg-desktop-portal-kde-6.2.4.tar.xz
8584f329202ec2860d24f24d2804fd55  drkonqi-6.2.4.tar.xz
077041dc6084e5a95e2ec519515a65dd  plasma-vault-6.2.4.tar.xz
#c5d0db08dfa4515a0ccef2f37bb58bb3  plasma-browser-integration-6.2.4.tar.xz
b8acc57a3dd34bd8fe8363e38c5f9060  kde-cli-tools-6.2.4.tar.xz
9e13f2bfe53dd1055229571db60538c2  systemsettings-6.2.4.tar.xz
fd80c0d75ebbf28ea9528b89116f4516  plasma-thunderbolt-6.2.4.tar.xz
#6e627c0b40c10f11fccabeef27de1e65  plasma-mobile-6.2.4.tar.xz
#a85167e03ff9bf13646a30d8377a0fec  plasma-nano-6.2.4.tar.xz
20d9d1d56e7a237c8caa85a2e1a6a42f  plasma-firewall-6.2.4.tar.xz
3209490a3e7d83ecdf9b99015730c8ad  plasma-systemmonitor-6.2.4.tar.xz
c569742ea3773a1974b49916fa0e7758  qqc2-breeze-style-6.2.4.tar.xz
31d65c9369168e894da260fdb7458fc9  ksystemstats-6.2.4.tar.xz
cc00b06ec43a532d1ba328f66f551d4f  oxygen-sounds-6.2.4.tar.xz
1c8ab0e36d6949b24561ecfa9397cac5  kdeplasma-addons-6.2.4.tar.xz
#493b2674a3c428241cb3de5ff31041fe  flatpak-kcm-6.2.4.tar.xz
7567ac573a47b814a4fa5b26f5f0a608  plasma-welcome-6.2.4.tar.xz
bcfe9b83adbc1fa180708980ba562a6f  ocean-sound-theme-6.2.4.tar.xz
19fe729b51a24a023dd179b9552d6ac5  print-manager-6.2.4.tar.xz
d8c405fc84f9868d6801ca819eb139ed  wacomtablet-6.2.4.tar.xz
#41204323446f19ec0f6e44cc83e281ae  kwayland-integration-6.2.4.tar.xz
#6ef4cf89fbfff92f1716c05b4afad6b9  krdp-6.2.4.tar.xz
b3408c1d938697feb688249ab5d52f2d  oxygen-6.2.4.tar.xz
#e7765045675048862ae8c130b2d09ed9  plasma-dialer-6.2.4.tar.xz
#57e7381b8c0bb1cef8a705451b63977f  spacebar-6.2.4.tar.xz</literal>
EOF</userinput></screen>

    <note>
      <title>About Commented Out Packages</title>
      <para>
        In the above list, several files are commented out with a hash (#) character.

        <itemizedlist spacing="compact">
          <listitem>
            <para>
              The plasma-sdk package is optional and used for software development.
            </para>
          </listitem>
          <listitem>
            <para>
              The discover package requires <xref linkend="appstream"/> to be built
              with the -D qt=true switch.
            </para>
          </listitem>
          <listitem>
            <para>
              The breeze-grub, breeze-plymouth, and plymouth-kcm packages above
              are all for customized support of 
              <ulink url="https://www.freedesktop.org/wiki/Software/Plymouth/">
              Plymouth</ulink> which is designed to be run within an initial 
              ram disk during boot (see <xref linkend="initramfs"/>).
            </para>
          </listitem>
          <listitem>
            <para>
              The plasma-browser-integration package is designed to implement
              browser integration for Plasma into Mozilla Firefox and Google
              Chrome. The package does build, but is only useful if you want
              these browsers to be integrated into the shell in a way that lets
              you see (and control) downloads from Plasma's notifications area,
              as well as allowing you to search browser history in the KDE
              Runner. Note that you must also install a browser extension for
              this to work. For more details, see
              <ulink url="https://community.kde.org/Plasma/Browser_Integration">
              the KDE Plasma wiki page about browser integration.</ulink>
            </para>
          </listitem>
          <listitem>
            <para>
              The krdp package is used to allow an RDP server to be run while
              using Plasma. This feature requires the 2.x version of FreeRDP,
              which is not in BLFS.
            </para>
          </listitem>
          <listitem>
            <para>
              The plasma-nano package is used for embedded systems.
            </para>
          </listitem>
          <listitem>
            <para>
              The plasma-mobile, plasma-dialer, and spacebar packages 
              provide phone functionality for Plasma.
            </para>
          </listitem>
          <listitem>
            <para>
              The flatpak-kcm package is for managing support of flatpak applications.
            </para>
          </listitem>
          <listitem>
            <para>
              The kwayland-integration application requires plasma5 support.
            </para>
          </listitem>
        </itemizedlist>
      </para>
    </note>

  </sect2>

  <sect2 role="installation">
    <title>Installation of Plasma</title>

    &as_root;

    <para>
      First, start a subshell that will exit on error:
    </para>

<screen><userinput>bash -e</userinput></screen>

    <para>
      Install all of the packages by running the following
      commands:
    </para>

<screen><userinput>while read -r line; do

    # Get the file name, ignoring comments and blank lines
    if $(echo $line | grep -E -q '^ *$|^#' ); then continue; fi
    file=$(echo $line | cut -d" " -f2)

    pkg=$(echo $file|sed 's|^.*/||')          # Remove directory
    srcdir=$(echo $pkg |sed 's|\.tar.*||')    # Source directory

    tar -xf $file
    pushd $srcdir
<!--
       # Fix some build issues when generating some configuration files
       case $name in
         plasma-workspace)
           sed -i '/set.HAVE_X11/a set(X11_FOUND 1)' CMakeLists.txt
         ;;

         khotkeys)
           sed -i '/X11Extras/a set(X11_FOUND 1)' CMakeLists.txt
         ;;

         plasma-desktop)
           sed -i '/X11.h)/i set(X11_FOUND 1)' CMakeLists.txt
         ;;
       esac
-->
       mkdir build
       cd    build

       cmake -D CMAKE_INSTALL_PREFIX=$KF6_PREFIX \
             -D CMAKE_INSTALL_LIBEXECDIR=libexec \
             -D CMAKE_BUILD_TYPE=Release         \
             -D BUILD_QT5=OFF                    \
             -D BUILD_TESTING=OFF                \
             -W no-dev ..  &amp;&amp;

        make
        as_root make install
    popd

<!-- some packages end up with files owned by root in $packagedir,
     so use as_root for removing -->
    as_root rm -rf $packagedir
    as_root /sbin/ldconfig

done &lt; plasma-&plasma-version;.md5

exit</userinput></screen>

    <para>
      If you did not set <envar>$KF6_PREFIX</envar> to
      <filename>/usr</filename>, create symlinks to allow display managers to
      find <application>Plasma</application>, and to allow the XDG Desktop
      Portal to be detected. As the &root; user:
    </para>

<screen role="root"><userinput># Setup xsessions (X11 sessions)
install -dvm 755 /usr/share/xsessions
cd /usr/share/xsessions

[ -e plasma.desktop ] ||
ln -sfv $KF6_PREFIX/share/xsessions/plasmax11.desktop 

# Setup wayland-sessions 
install -dvm 755 /usr/share/wayland-sessions
cd /usr/share/wayland-sessions

[ -e plasmawayland.desktop ] ||
ln -sfv $KF6_PREFIX/share/wayland-sessions/plasma.desktop
<!-- work around a bug in xdg-desktop-portal-->
# Setup xdg-desktop-portal
install -dvm 755 /usr/share/xdg-desktop-portal
cd /usr/share/xdg-desktop-portal 

[ -e kde-portals.conf ] ||
ln -sfv $KF6_PREFIX/share/xdg-desktop-portal/kde-portals.conf

# Setup kde portal
install -dvm 755 /usr/share/xdg-desktop-portal/portals
cd /usr/share/xdg-desktop-portal/portals

[ -e kde.portal ] ||
ln -sfv $KF6_PREFIX/share/xdg-desktop-portal/portals/kde.portal</userinput></screen>

    <para revision="sysv">
      Useless systemd units have been installed in
      <filename class="directory">$KF6_PREFIX/lib</filename>. Remove
      them now (as <systemitem class="username">root</systemitem>):
    </para>

<screen role="root"
        revision="sysv"><userinput>rm -rf $KF6_PREFIX/lib/systemd</userinput></screen>

  </sect2>
<!--
    <sect2 role="commands">
    <title>Command Explanations</title>

    <para>
      <command>ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/</command>:
      Create symbolic links so qml files can find needed javascript modules.
    </para>

  </sect2>
-->
  <sect2 role="configuration">
    <title>Configuring Plasma</title>

    <sect3>
      <title>Linux PAM Configuration</title>

      <para>
        If you built Plasma with the recommended <application>Linux
        PAM</application> support, create necessary configuration files by
        running the following commands as the <systemitem
        class="username">root</systemitem> user:
      </para>

<screen role="root"><userinput>cat &gt; /etc/pam.d/kde &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kde

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     include        system-auth

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde</literal>
EOF

cat &gt; /etc/pam.d/kde-np &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kde-np

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     required       pam_permit.so

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde-np</literal>
EOF

cat &gt; /etc/pam.d/kscreensaver &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kscreensaver

auth    include system-auth
account include system-account

# End /etc/pam.d/kscreensaver</literal>
EOF</userinput></screen>
    </sect3>
  </sect2>

  <sect2 role="starting">
    <title>Starting Plasma</title>

    <para revision="sysv">
      You can start <application>Plasma</application> from runlevel 3, using
      <xref linkend="xinit"/>, or from runlevel 5, using a Display Manager,
      such as <xref linkend="lightdm"/>.
    </para>

    <para revision="systemd">
      You can start <application>Plasma</application> from a TTY, using
      <xref linkend="xinit"/><!--, or from a graphical display manager, such as
      <xref linkend="sddm"/>-->.
    </para>

    <para>
      To start <application>Plasma</application> using <xref linkend="xinit"/>,
      run the following commands:
    </para>

<screen role="nodump"><userinput>cat &gt; ~/.xinitrc &lt;&lt; "EOF"
<literal>dbus-launch --exit-with-x11 $KF6_PREFIX/bin/startplasma-x11</literal>
EOF

startx</userinput></screen>

    <para>
      The X session starts on the first unused virtual terminal, normally vt7.
      You can switch to another vt<emphasis>n</emphasis> simultaneously
      pressing the keys Ctrl-Alt-F<emphasis>n</emphasis>
      (<emphasis>n</emphasis>=1, 2, ...).  To switch back to the X session,
      normally started at vt7, use Ctrl-Alt-F7. The vt where the command
      <command>startx</command> was executed will display many messages,
      including X starting messages, applications automatically started with
      the session, and eventually, some warning and error messages. You may
      prefer to redirect those messages to a log file, which not only will keep
      the initial vt uncluttered, but can also be used for debugging purposes. This
      can be done starting X with:
    </para>

    <screen role="nodump"><userinput>startx &amp;&gt; ~/x-session-errors</userinput></screen>

    <para>
      When shutting down or rebooting, the shutdown messages appear on the vt
      where X was running. If you wish to see those messages, simultaneously
      press keys Alt-F7 (assuming that X was running on vt7).
    </para>
<!-- Start plasma wayland with 

/opt/kf6/lib/libexec/plasma-dbus-run-session-if-needed /opt/kf6/bin/startplasma-wayland

Investigate why it's in /opt/kf6/lib/libexec and not just in /opt/kf6/libexec


Now the entry is "plasma (X11)" for Xorg, so I guess this is
     not needed anymore:
    <para>
      If you intend to start <application>Plasma</application> using a
    display manager such as <xref linkend="lightdm"/>, there will be two entries
    for <application>Plasma</application>, one for use with
    <application>Xorg</application>, and another for
    <application>Wayland</application>. Modify the
    <application>Xorg</application> entry with the following command, as the
    <systemitem class="username">root</systemitem> user, so that you can
    differentiate between the two:</para>

<screen role="root"><userinput>sed '/^Name=/s/Plasma/Plasma on Xorg/' -i /usr/share/xsessions/plasma.desktop</userinput></screen>
-->

  </sect2>

  <sect2 role="content">
    <title>Contents</title>

    <segmentedlist>
      <segtitle>Installed Programs</segtitle>
      <segtitle>Installed Libraries</segtitle>
      <segtitle>Installed Directories</segtitle>

      <seglistitem>
        <seg>
           There are too many plasma programs (over 50 in /opt/kf6/bin) to list
           separately here.
        </seg>
        <seg>
           There are too many plasma libraries (over 250 in /opt/kf6/lib) to list
           separately here.
        </seg>
        <seg>
           There are too many plasma directories (over 2700 in /opt/kf6) to
           list separately here.
        </seg>
      </seglistitem>
    </segmentedlist>

  </sect2>

</sect1>
