<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
 <!ENTITY % general-entities SYSTEM "../../general.ent">
 %general-entities;

  <!ENTITY plasma-download-http "https://download.kde.org/stable/plasma/&plasma-version;">
  <!ENTITY plasma-download-ftp  " ">
  <!ENTITY plasma-md5sum        "See Below">
  <!ENTITY plasma-size          "220 MB">
  <!ENTITY plasma-buildsize     "1.1 GB (557 MB installed)">
  <!ENTITY plasma-time          "15 SBU (using parallelism=8)">
]>

<sect1 id="plasma-build" xreflabel="Plasma-&plasma-version;">
  <?dbhtml filename="plasma-all.html"?>


  <title>Building Plasma</title>

  <indexterm zone="plasma-build">
     <primary sortas="a-kde-plasma">KDE Plasma</primary>
  </indexterm>

  <para>
    KDE Plasma is a collection of packages based on top of KDE Frameworks
    and QML. They implement the KDE Display Environment (Plasma).
  </para>

  &lfs122_checked;

  <para>
    The instructions below build all of the Plasma packages in one
    step by using a bash script.
  </para>

  <bridgehead renderas="sect3">Package Information</bridgehead>
  <itemizedlist spacing="compact">
    <listitem>
      <para>
        Download (HTTP): <ulink url="&plasma-download-http;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Download (FTP): <ulink url="&plasma-download-ftp;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Download MD5 sum: &plasma-md5sum;
      </para>
    </listitem>
    <listitem>
      <para>
        Download size: &plasma-size;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimated disk space required: &plasma-buildsize;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimated build time: &plasma-time;
      </para>
    </listitem>
  </itemizedlist>

  <bridgehead renderas="sect3">Plasma Dependencies</bridgehead>

  <bridgehead renderas="sect4">Required</bridgehead>
  <para role="required">
    <xref linkend="boost"/>,
    <xref linkend="gtk3"/>,
    <xref linkend="kf6-frameworks"/>,
    <xref linkend="kirigami-addons"/>,
    <xref linkend="libdisplay-info"/>,
    <xref linkend="libpwquality"/>,
    <xref linkend="libqalculate"/>,
    <xref linkend="libnl"/>,
    <xref linkend="libxcvt"/>,
    <xref linkend="libxkbcommon"/>,
    <xref linkend="mesa"/> built with <xref linkend="wayland"/>,
    <xref linkend="pipewire"/>,
    <xref linkend="pulseaudio-qt"/>,
    <xref linkend="qca"/>,
    <xref linkend="qcoro"/>,
    <xref linkend="sassc"/>,
    <xref linkend="taglib"/>, 
    <xref linkend="xdotool"/>, and 
    <xref linkend="xorg-evdev-driver"/>
  </para>

  <bridgehead renderas="sect4">Recommended</bridgehead>
  <para role="recommended">
    <xref linkend="gsettings-desktop-schemas"/>,
    <xref linkend="libcanberra"/>,
    <xref linkend="libinput"/>,
    <xref linkend="libpcap"/>,
    <xref linkend="libwacom"/>,
    <xref linkend="linux-pam"/>,
    <xref linkend="lm_sensors"/>,
    <xref linkend="oxygen-icons"/>, 
    <xref linkend="pciutils"/>, 
    <xref linkend="power-profiles-daemon"/>, and 
    the following Python modules: 
      <xref linkend="psutil"/>,
      <xref linkend="pygdbmi"/>,
      <xref linkend="sentry-sdk"/>, 
      <xref linkend="urllib3"/> (if they are not installed, they will be
      downloaded and installed by the drkonqi build procedure)
  </para>

  <bridgehead renderas="sect4">Recommended (runtime)</bridgehead>
  <para role="recommended">
    <xref role="runtime" linkend="accountsservice"/>,
    <xref role="runtime" linkend="breeze-icons"/>,
    <xref role="runtime" linkend="kio-extras"/>,
    <xref role="runtime" linkend="smartmontools"/>,
    <xref role="runtime" linkend="xdg-desktop-portal"/>, and
    <xref role="runtime" linkend="xwayland"/>
  </para>

  <bridgehead renderas="sect4">Optional</bridgehead>
  <para role="optional">
    <xref linkend="appstream"/> (build with -qt=true),
    <xref linkend="glu"/>,
    <xref linkend='ibus'/>,
    <xref linkend='qtwebengine'/>,
    <xref linkend="xorg-synaptics-driver"/>,
    <ulink url="https://www.kdevelop.org/">KDevPlatform</ulink>,
    <ulink url="https://gpsd.gitlab.io/gpsd/">libgps</ulink>,
    <ulink url="https://github.com/libhybris/libhybris">libhybris</ulink>,
    <ulink url="https://www.freedesktop.org/software/PackageKit/releases/">packagekit-qt</ulink>,
    <ulink url="https://launchpad.net/qapt">Qapt</ulink>,
    <ulink url="https://github.com/osiam/osiam">SCIM</ulink>, and
    <ulink url="http://www.dest-unreach.org/socat/">socat</ulink> (for pam_kwallet)
  </para>

  <sect2>
    <title>Downloading KDE Plasma</title>

    <para>
      The easiest way to get the KDE Plasma packages is to use a single
      <command>wget</command> to fetch them all at once:
    </para>

<screen><userinput>url=https://download.kde.org/stable/plasma/&plasma-version;/
wget -r -nH -nd -A '*.xz' -np $url</userinput>
<literal>
The options used here are:
  -r            recurse through child directories
  -nH           disable generation of host-prefixed directories
  -nd           do not create a hierarchy of directories
  -A '*.xz'     just get the *.xz files
  -np           don't get parent directories</literal></screen>

   </sect2>

  <sect2>
    <title>Setting Package Order</title>

    <para>
      The order of building files is important due to internal dependencies.
      Create the list of files in the proper order as follows:
    </para>

<screen><userinput>cat &gt; plasma-&plasma-version;.md5 &lt;&lt; "EOF"
<literal>2ff46f54fa0ed2984aa634ab8ed92f8c  kdecoration-6.2.3.tar.xz
d673a0d084abd008f1b56c4a2479a7f2  libkscreen-6.2.3.tar.xz
0caba5f7a6ebfbef8adc2be63933cd48  libksysguard-6.2.3.tar.xz
a8564513b84247f088c7e75b41d2a8c7  breeze-6.2.3.tar.xz
24b589121e783a426c74b8dc7c6f8214  breeze-gtk-6.2.3.tar.xz
800123309cc8d13124e58d7c500a3a8f  layer-shell-qt-6.2.3.tar.xz
fb06ef191171a9604cbc047a35aababf  plasma-activities-6.2.3.tar.xz
2120432a72864a558bbc124294ce2ce1  libplasma-6.2.3.tar.xz
888ef82d656558bb3304bea88c9c0ce6  kscreenlocker-6.2.3.tar.xz
611d671fd49017b965cf3974a2cd5b8e  kinfocenter-6.2.3.tar.xz
d982c89b0acce4b7f043e20bcfbd7036  kglobalacceld-6.2.3.tar.xz
080ee5a3a656ba26065df377cc81aded  kwayland-6.2.3.tar.xz
019589ac9cb5c62c92b6deb12bbfce61  kwin-6.2.3.tar.xz
32c23ff1e45f1afa01643f2c90fbb74e  plasma5support-6.2.3.tar.xz
4334541dcd6c6a6b825e94cf2d4ed273  plasma-activities-stats-6.2.3.tar.xz
f2a70f77f66d1c4fb14f384217f0ce09  kpipewire-6.2.3.tar.xz
2ee9b479ba7a93b6084e23fa92e11db2  plasma-workspace-6.2.3.tar.xz
29e3fcd5c49f5594e5877e02b04a1605  plasma-disks-6.2.3.tar.xz
48542e331ccab756b513c00c123d283d  bluedevil-6.2.3.tar.xz
db57c0c1d0fcefe472ba9812cf34f239  kde-gtk-config-6.2.3.tar.xz
34ebd64804d8893545a581ee96a97923  kmenuedit-6.2.3.tar.xz
bba08b76c7a2f772a231f18903b6be12  kscreen-6.2.3.tar.xz
e50d03eb4d441df8757ccbbe58dc7c94  kwallet-pam-6.2.3.tar.xz
12a80fec3f6fe7c1925a19f8eec11c04  kwrited-6.2.3.tar.xz
0e4eaf0cf4ffb933be0d2a7e2fb22240  milou-6.2.3.tar.xz
ab6c9776d0786f12a94b463b3a9d8d51  plasma-nm-6.2.3.tar.xz
ddb1affae30b0b2e1c63ccad15cdc177  plasma-pa-6.2.3.tar.xz
3446af3b74b524bc3f78e9ba7fa2c02d  plasma-workspace-wallpapers-6.2.3.tar.xz
028409d3047f4165b9a08fa08d3862ba  polkit-kde-agent-1-6.2.3.tar.xz
bee8f1f66d58bfc8d598bc7226675da7  powerdevil-6.2.3.tar.xz
8be259b550487f7c7ae0feb426d3ab28  plasma-desktop-6.2.3.tar.xz
bdd6b9594a84c6e340a14c5a8934b0d9  kgamma-6.2.3.tar.xz
7ed2630122af143355ef9078f6040cf8  ksshaskpass-6.2.3.tar.xz
#b3718f5169a8d0f85c006f4805c6c16d  plasma-sdk-6.2.3.tar.xz
0c322a9cc0fd81f05cde6334f091774d  sddm-kcm-6.2.3.tar.xz
#9ad8746a959401eb5a74fb29870c91d3  discover-6.2.3.tar.xz
#dda2a050c14b9516024d167353b9e7f1  breeze-grub-6.2.3.tar.xz
#32852747cbeed189160902d651c95d13  breeze-plymouth-6.2.3.tar.xz
a8ab17c1bbcf578171219f9f4b54604b  kactivitymanagerd-6.2.3.tar.xz
f7aecc20a94b44752361526ae03aea52  plasma-integration-6.2.3.tar.xz
#80b6397d3e154f00266baefeb17967af  plymouth-kcm-6.2.3.tar.xz
d2be45993ca6a6599a48a8b735c55678  xdg-desktop-portal-kde-6.2.3.tar.xz
6583c822bcb6706045ebc1f311319265  drkonqi-6.2.3.tar.xz
2d95e1a177c560870fd1526f887941ea  plasma-vault-6.2.3.tar.xz
#29d6f2e4d5f6bac6c09f6fdf9899f04f  plasma-browser-integration-6.2.3.tar.xz
599d20509fdfd9ddb19bd29c96f50864  kde-cli-tools-6.2.3.tar.xz
d3666adee8e1f40c7d14c1614da29ac5  systemsettings-6.2.3.tar.xz
2d9aeb85c8d1e785a6f5a77b9a06ae93  plasma-thunderbolt-6.2.3.tar.xz
#8c71739b1a81c0cc2671cb7788d96e8b  plasma-mobile-6.2.3.tar.xz
#b812a62332fba386ebcb55e7e5e74ba5  plasma-nano-6.2.3.tar.xz
460e9a295071ab61dd0edcd5bf6d6a73  plasma-firewall-6.2.3.tar.xz
cbbcd79945028a2e39e7ebcd91b694c2  plasma-systemmonitor-6.2.3.tar.xz
41dc8992289b773b477bccd80e786af0  qqc2-breeze-style-6.2.3.tar.xz
e8c39d26e3784b83bd21cfa2b480f7ca  ksystemstats-6.2.3.tar.xz
dc548c81d9e3f2cad96391f790950a5c  oxygen-sounds-6.2.3.tar.xz
13b47b5f1233ddb94ed0a813635398c0  kdeplasma-addons-6.2.3.tar.xz
#c3d42d9371adecca58eeff6409001954  flatpak-kcm-6.2.3.tar.xz
166d2f5513667eaeb1f115bcccfbe20d  plasma-welcome-6.2.3.tar.xz
a444d387e8a5f60d1539f3469a08ead6  ocean-sound-theme-6.2.3.tar.xz
edb63b916fd2c60b58cfb78cee174ef4  print-manager-6.2.3.tar.xz
d063c75f86ba6e08301417c92658b16e  wacomtablet-6.2.3.tar.xz
#b685048d3fa905b9236e8072bba52a71  kwayland-integration-6.2.3.tar.xz
#347d06cf599e522a21cb0dbb4db543fb  krdp-6.2.3.tar.xz
94675901de34a1f68c03c85a81f5f761  oxygen-6.2.3.tar.xz
#0b5b18fba0f3ea88020e941671fb278f  plasma-dialer-6.2.3.tar.xz
#d469683d867b471c31e859a378579a0c  spacebar-6.2.3.tar.xz</literal>
EOF</userinput></screen>

    <note>
      <title>About Commented Out Packages</title>
      <para>
        In the above list, several files are commented out with a hash (#) character.

        <itemizedlist spacing="compact">
          <listitem>
            <para>
              The plasma-sdk package is optional and used for software development.
            </para>
          </listitem>
          <listitem>
            <para>
              The discover package requires <xref linkend="appstream"/> to be built
              with the -D qt=true switch.
            </para>
          </listitem>
          <listitem>
            <para>
              The breeze-grub, breeze-plymouth, and plymouth-kcm packages above
              are all for customized support of 
              <ulink url="https://www.freedesktop.org/wiki/Software/Plymouth/">
              Plymouth</ulink> which is designed to be run within an initial 
              ram disk during boot (see <xref linkend="initramfs"/>).
            </para>
          </listitem>
          <listitem>
            <para>
              The plasma-browser-integration package is designed to implement
              browser integration for Plasma into Mozilla Firefox and Google
              Chrome. The package does build, but is only useful if you want
              these browsers to be integrated into the shell in a way that lets
              you see (and control) downloads from Plasma's notifications area,
              as well as allowing you to search browser history in the KDE
              Runner. Note that you must also install a browser extension for
              this to work. For more details, see
              <ulink url="https://community.kde.org/Plasma/Browser_Integration">
              the KDE Plasma wiki page about browser integration.</ulink>
            </para>
          </listitem>
          <listitem>
            <para>
              The krdp package is used to allow an RDP server to be run while
              using Plasma. This feature requires the 2.x version of FreeRDP,
              which is not in BLFS.
            </para>
          </listitem>
          <listitem>
            <para>
              The plasma-nano package is used for embedded systems.
            </para>
          </listitem>
          <listitem>
            <para>
              The plasma-mobile, plasma-dialer, and spacebar packages 
              provide phone functionality for Plasma.
            </para>
          </listitem>
          <listitem>
            <para>
              The flatpak-kcm package is for managing support of flatpak applications.
            </para>
          </listitem>
          <listitem>
            <para>
              The kwayland-integration application requires plasma5 support.
            </para>
          </listitem>
        </itemizedlist>
      </para>
    </note>

  </sect2>

  <sect2 role="installation">
    <title>Installation of Plasma</title>

    &as_root;

    <para>
      First, start a subshell that will exit on error:
    </para>

<screen><userinput>bash -e</userinput></screen>

    <para>
      Install all of the packages by running the following
      commands:
    </para>

<screen><userinput>while read -r line; do

    # Get the file name, ignoring comments and blank lines
    if $(echo $line | grep -E -q '^ *$|^#' ); then continue; fi
    file=$(echo $line | cut -d" " -f2)

    pkg=$(echo $file|sed 's|^.*/||')          # Remove directory
    srcdir=$(echo $pkg |sed 's|\.tar.*||')    # Source directory

    tar -xf $file
    pushd $srcdir
<!--
       # Fix some build issues when generating some configuration files
       case $name in
         plasma-workspace)
           sed -i '/set.HAVE_X11/a set(X11_FOUND 1)' CMakeLists.txt
         ;;

         khotkeys)
           sed -i '/X11Extras/a set(X11_FOUND 1)' CMakeLists.txt
         ;;

         plasma-desktop)
           sed -i '/X11.h)/i set(X11_FOUND 1)' CMakeLists.txt
         ;;
       esac
-->
       mkdir build
       cd    build

       cmake -D CMAKE_INSTALL_PREFIX=$KF6_PREFIX \
             -D CMAKE_INSTALL_LIBEXECDIR=libexec \
             -D CMAKE_BUILD_TYPE=Release         \
             -D BUILD_QT5=OFF                    \
             -D BUILD_TESTING=OFF                \
             -W no-dev ..  &amp;&amp;

        make
        as_root make install
    popd

<!-- some packages end up with files owned by root in $packagedir,
     so use as_root for removing -->
    as_root rm -rf $packagedir
    as_root /sbin/ldconfig

done &lt; plasma-&plasma-version;.md5

exit</userinput></screen>

    <para>
      If you did not set <envar>$KF6_PREFIX</envar> to
      <filename>/usr</filename>, create symlinks to allow display managers to
      find <application>Plasma</application>, and to allow the XDG Desktop
      Portal to be detected. As the &root; user:
    </para>

<screen><userinput># Setup xsessions (X11 sessions)
install -dvm 755 /usr/share/xsessions
cd /usr/share/xsessions

[ -e plasma.desktop ] ||
ln -sfv $KF6_PREFIX/share/xsessions/plasmax11.desktop 

# Setup wayland-sessions 
install -dvm 755 /usr/share/wayland-sessions
cd /usr/share/wayland-sessions

[ -e plasmawayland.desktop ] ||
ln -sfv $KF6_PREFIX/share/wayland-sessions/plasma.desktop
<!-- work around a bug in xdg-desktop-portal-->
# Setup xdg-desktop-portal
install -dvm 755 /usr/share/xdg-desktop-portal
cd /usr/share/xdg-desktop-portal 

[ -e kde-portals.conf ] ||
ln -sfv $KF6_PREFIX/share/xdg-desktop-portal/kde-portals.conf

# Setup kde portal
install -dvm 755 /usr/share/xdg-desktop-portal/portals
cd /usr/share/xdg-desktop-portal/portals

[ -e kde.portal ] ||
ln -sfv $KF6_PREFIX/share/xdg-desktop-portal/portals/kde.portal</userinput></screen>

    <para revision="sysv">
      Useless systemd units have been installed in
      <filename class="directory">$KF6_PREFIX/lib</filename>. Remove
      them now (as <systemitem class="username">root</systemitem>):
    </para>

<screen role="root"
        revision="sysv"><userinput>rm -rf $KF6_PREFIX/lib/systemd</userinput></screen>

  </sect2>
<!--
    <sect2 role="commands">
    <title>Command Explanations</title>

    <para>
      <command>ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/</command>:
      Create symbolic links so qml files can find needed javascript modules.
    </para>

  </sect2>
-->
  <sect2 role="configuration">
    <title>Configuring Plasma</title>

    <sect3>
      <title>Linux PAM Configuration</title>

      <para>
        If you built Plasma with the recommended <application>Linux
        PAM</application> support, create necessary configuration files by
        running the following commands as the <systemitem
        class="username">root</systemitem> user:
      </para>

<screen role="root"><userinput>cat &gt; /etc/pam.d/kde &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kde

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     include        system-auth

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde</literal>
EOF

cat &gt; /etc/pam.d/kde-np &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kde-np

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     required       pam_permit.so

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde-np</literal>
EOF

cat &gt; /etc/pam.d/kscreensaver &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kscreensaver

auth    include system-auth
account include system-account

# End /etc/pam.d/kscreensaver</literal>
EOF</userinput></screen>
    </sect3>
  </sect2>

  <sect2 role="starting">
    <title>Starting Plasma</title>

    <para revision="sysv">
      You can start <application>Plasma</application> from runlevel 3, using
      <xref linkend="xinit"/>, or from runlevel 5, using a Display Manager,
      such as <xref linkend="lightdm"/>.
    </para>

    <para revision="systemd">
      You can start <application>Plasma</application> from a TTY, using
      <xref linkend="xinit"/><!--, or from a graphical display manager, such as
      <xref linkend="sddm"/>-->.
    </para>

    <para>
      To start <application>Plasma</application> using <xref linkend="xinit"/>,
      run the following commands:
    </para>

<screen role="nodump"><userinput>cat &gt; ~/.xinitrc &lt;&lt; "EOF"
<literal>dbus-launch --exit-with-x11 $KF6_PREFIX/bin/startplasma-x11</literal>
EOF

startx</userinput></screen>

    <para>
      The X session starts on the first unused virtual terminal, normally vt7.
      You can switch to another vt<emphasis>n</emphasis> simultaneously
      pressing the keys Ctrl-Alt-F<emphasis>n</emphasis>
      (<emphasis>n</emphasis>=1, 2, ...).  To switch back to the X session,
      normally started at vt7, use Ctrl-Alt-F7. The vt where the command
      <command>startx</command> was executed will display many messages,
      including X starting messages, applications automatically started with
      the session, and eventually, some warning and error messages. You may
      prefer to redirect those messages to a log file, which not only will keep
      the initial vt uncluttered, but can also be used for debugging purposes. This
      can be done starting X with:
    </para>

    <screen role="nodump"><userinput>startx &amp;&gt; ~/x-session-errors</userinput></screen>

    <para>
      When shutting down or rebooting, the shutdown messages appear on the vt
      where X was running. If you wish to see those messages, simultaneously
      press keys Alt-F7 (assuming that X was running on vt7).
    </para>
<!-- Start plasma wayland with 

/opt/kf6/lib/libexec/plasma-dbus-run-session-if-needed /opt/kf6/bin/startplasma-wayland

Investigate why it's in /opt/kf6/lib/libexec and not just in /opt/kf6/libexec


Now the entry is "plasma (X11)" for Xorg, so I guess this is
     not needed anymore:
    <para>
      If you intend to start <application>Plasma</application> using a
    display manager such as <xref linkend="lightdm"/>, there will be two entries
    for <application>Plasma</application>, one for use with
    <application>Xorg</application>, and another for
    <application>Wayland</application>. Modify the
    <application>Xorg</application> entry with the following command, as the
    <systemitem class="username">root</systemitem> user, so that you can
    differentiate between the two:</para>

<screen role="root"><userinput>sed '/^Name=/s/Plasma/Plasma on Xorg/' -i /usr/share/xsessions/plasma.desktop</userinput></screen>
-->

  </sect2>

  <sect2 role="content">
    <title>Contents</title>

    <segmentedlist>
      <segtitle>Installed Programs</segtitle>
      <segtitle>Installed Libraries</segtitle>
      <segtitle>Installed Directories</segtitle>

      <seglistitem>
        <seg>
           There are too many plasma programs (over 50 in /opt/kf6/bin) to list
           separately here.
        </seg>
        <seg>
           There are too many plasma libraries (over 250 in /opt/kf6/lib) to list
           separately here.
        </seg>
        <seg>
           There are too many plasma directories (over 2700 in /opt/kf6) to
           list separately here.
        </seg>
      </seglistitem>
    </segmentedlist>

  </sect2>

</sect1>
